# Azure Pipelines YAML

trigger:
  branches:
    include:
      - main  # Adjust based on your repository branch

pool:
  vmImage: 'ubuntu-latest'  # Or select another image based on your requirements

variables:
  pythonVersion: '3.9'
  scriptDirectory: '$(Build.SourcesDirectory)'
  pdfDirectory: 'pdfs'  # Assuming PDFs are in a folder named 'pdfs'
  signedPdfOutput: 'signed_output.pdf'
  artifactName: 'SignedPDFs'

steps:
  - task: UsePythonVersion@0
    inputs:
      versionSpec: $(pythonVersion)
    displayName: 'Set Python Version'

  - script: |
      python -m pip install --upgrade pip
      pip install virtualenv
    displayName: 'Upgrade pip and install virtualenv'

  - script: |
      virtualenv venv
      source venv/bin/activate
      pip install pyOpenSSL PyPDF2 PDFNetPython3
    displayName: 'Setup Virtual Environment and Install Dependencies'

  - script: |
      source venv/bin/activate
      python $(scriptDirectory)/sign_pdf.py \
        --input_path $(scriptDirectory)/$(pdfDirectory) \
        --signatureID 'sig1' --x_coordinate 50 --y_coordinate 200 \
        --output_file $(scriptDirectory)/$(signedPdfOutput)
    displayName: 'Run PDF Signing Script'

  - task: CopyFiles@2
    inputs:
      SourceFolder: $(scriptDirectory)/$(pdfDirectory)
      Contents: '**/*.pdf'
      TargetFolder: '$(Build.ArtifactStagingDirectory)'
    displayName: 'Copy Signed PDFs to Artifact Staging Directory'

  - task: PublishBuildArtifacts@1
    inputs:
      pathToPublish: '$(Build.ArtifactStagingDirectory)'
      artifactName: $(artifactName)-$(Date:yyyyMMdd)
      publishLocation: 'Container'
    displayName: 'Publish Signed PDFs'
